<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"/>

    <!-- Necessary includes for LocusZoom.js -->
    <script src="../dist/locuszoom.vendor.min.js" type="text/javascript"></script>
    <script src="../dist/locuszoom.app.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../dist/locuszoom.css" type="text/css"/>

    <title>LocusZoom.js ~ PheWAS (Forest) Example</title>

    <style>
      body {
        background-color: #FAFAFA;
        margin: 0px 20px;
      }
      img {
        max-width: 100%;
        box-sizing: border-box;
      }
    </style>

  </head>

  <body>
    <div class="container">

      <h1 style="margin-top: 1em;"><strong>LocusZoom.js</strong></h1>

      <h3 style="float: left; color: #777">PheWAS (Forest) Example</h3>
      <h6 style="float: right;"><a href="../index.html">&lt; return home</a></h6>

      <hr style="clear: both;">

      <p>This example shows a forest plot approach to visualizing Phenome-Wide Association Study (PheWAS) results. This is useful when effect sizes (odds ratios or betas) and confidence intervals are available in the data set.</p>
      <p>Data in this example plot is randomly generated. Phenotypes are listed vertically (unsorted) along the y2-axis with betas plotted along the x-axis. P-values are used to determine both size and color for points on the plot using an interpolated sequential scale.<p>

      <a href="javascript:void(0);" onclick="window.plot.applyState()"><strong>Random Filter</strong></a>
      <div id="plot"></div>

      <hr>

      <div class="row">
        <footer style="text-align: center;">
          &copy; Copyright 2019 <a href="https://github.com/statgen">The University of Michigan Center for Statistical Genetics</a><br>
        </footer>
      </div>

      <script type="text/javascript">

        var phewas_forest = {
          "data": [
            {
              "phenotype": "Bone cancer",
              "log_pvalue": 0.469,
              "beta": -0.033,
              "ci_start": -0.065,
              "ci_end": 0.016
            },
            {
              "phenotype": "Neurofibromatosis",
              "log_pvalue": 0.319,
              "beta": -0.018,
              "ci_start": -0.033,
              "ci_end": 0.003
            },
            {
              "phenotype": "Hypothyroidism",
              "log_pvalue": 0.707,
              "beta": -0.01975,
              "ci_start": -0.081,
              "ci_end": 0.047
            },
            {
              "phenotype": "Type 1 diabetes",
              "log_pvalue": 0.5681,
              "beta": -0.00425,
              "ci_start": -0.113,
              "ci_end": 0.049
            },
            {
              "phenotype": "Type 2 diabetes",
              "log_pvalue": 5.6754,
              "beta": -0.02825,
              "ci_start": -0.063,
              "ci_end": -0.005
            },
            {
              "phenotype": "Abnormal glucose",
              "log_pvalue": 0.545,
              "beta": -0.02225,
              "ci_start": -0.074,
              "ci_end": 0.042
            },
            {
              "phenotype": "Impaired fasting glucose",
              "log_pvalue": 0.5681,
              "beta": 0.01,
              "ci_start": -0.029,
              "ci_end": 0.045
            },
            {
              "phenotype": "Diabetic retinopathy",
              "log_pvalue": 0.437,
              "beta": 0.02475,
              "ci_start": -0.002,
              "ci_end": 0.052
            },
            {
              "phenotype": "Hypoglycemia",
              "log_pvalue": 0.647,
              "beta": -0.021,
              "ci_start": -0.089,
              "ci_end": 0.078
            },
            {
              "phenotype": "Adrenal hyperfunction",
              "log_pvalue": 0.8561,
              "beta": 0.0275,
              "ci_start": -0.021,
              "ci_end": 0.091
            },
            {
              "phenotype": "Proteinuria",
              "log_pvalue": 0.40803,
              "beta": 0.0385,
              "ci_start": -0.018,
              "ci_end": 0.121
            },
            {
              "phenotype": "Hypocalcemia",
              "log_pvalue": 0.517,
              "beta": -0.0375,
              "ci_start": -0.081,
              "ci_end": -0.015
            },
            {
              "phenotype": "Disorders of bilirubin excretion",
              "log_pvalue": 0.776,
              "beta": -0.00775,
              "ci_start": -0.093,
              "ci_end": 0.105
            },
            {
              "phenotype": "Morbid obesity",
              "log_pvalue": 1.048,
              "beta": -0.00625,
              "ci_start": -0.035,
              "ci_end": 0.068
            },
            {
              "phenotype": "Megaloblastic anemia",
              "log_pvalue": 2.28,
              "beta": 0.032,
              "ci_start": 0.022,
              "ci_end": 0.038
            },
            {
              "phenotype": "Pancytopenia",
              "log_pvalue": 1.178,
              "beta": -0.002,
              "ci_start": -0.027,
              "ci_end": 0.032
            },
            {
              "phenotype": "Primary thrombocytopenia",
              "log_pvalue": 2.231,
              "beta": 0.00925,
              "ci_start": -0.079,
              "ci_end": 0.057
            },
            {
              "phenotype": "Aphasia",
              "log_pvalue": 0.829,
              "beta": -0.02175,
              "ci_start": -0.053,
              "ci_end": 0.017
            },
            {
              "phenotype": "Schizophrenia",
              "log_pvalue": 0.814,
              "beta": -0.032,
              "ci_start": -0.077,
              "ci_end": -0.006
            },
            {
              "phenotype": "Obsessive-compulsive disorders",
              "log_pvalue": 9.47,
              "beta": -0.0115,
              "ci_start": -0.041,
              "ci_end": 0.09
            },
            {
              "phenotype": "Encephalitis",
              "log_pvalue": 0.1551,
              "beta": 0.007,
              "ci_start": -0.039,
              "ci_end": 0.02
            },
            {
              "phenotype": "Hypersomnia",
              "log_pvalue": 0.864,
              "beta": -0.02625,
              "ci_start": -0.105,
              "ci_end": 0.089
            },
            {
              "phenotype": "Parkinson's disease",
              "log_pvalue": 2.0334,
              "beta": -0.0275,
              "ci_start": -0.043,
              "ci_end": -0.007
            },
            {
              "phenotype": "Epilepsy",
              "log_pvalue": 0.456,
              "beta": -0.01675,
              "ci_start": -0.029,
              "ci_end": 0.013
            },
            {
              "phenotype": "Complex regional/central pain syndrome",
              "log_pvalue": 0.0404,
              "beta": -0.00325,
              "ci_start": -0.035,
              "ci_end": 0.05
            },
            {
              "phenotype": "Retinal detachments and defects",
              "log_pvalue": 0.876,
              "beta": 0.00875,
              "ci_start": -0.02,
              "ci_end": 0.069
            },
            {
              "phenotype": "Fuchs' dystrophy",
              "log_pvalue": 17.3972,
              "beta": -0.037,
              "ci_start": -0.071,
              "ci_end": -0.006
            },
            {
              "phenotype": "Myopia",
              "log_pvalue": 0.52,
              "beta": 0.0365,
              "ci_start": -0.005,
              "ci_end": 0.054
            },
            {
              "phenotype": "Scleritis and episcleritis",
              "log_pvalue": 1.966,
              "beta": 0.021,
              "ci_start": -0.035,
              "ci_end": 0.116
            },
            {
              "phenotype": "Otosclerosis",
              "log_pvalue": 1.274,
              "beta": -0.031,
              "ci_start": -0.046,
              "ci_end": -0.002
            },
            {
              "phenotype": "Cholesteatoma",
              "log_pvalue": 0.616,
              "beta": -0.01575,
              "ci_start": -0.057,
              "ci_end": 0.071
            },
            {
              "phenotype": "Meniere's disease",
              "log_pvalue": 0.424,
              "beta": -0.02075,
              "ci_start": -0.048,
              "ci_end": 0.022
            },
            {
              "phenotype": "Labyrinthitis",
              "log_pvalue": 1.44,
              "beta": 0.012,
              "ci_start": 0,
              "ci_end": 0.028
            },
            {
              "phenotype": "Coronary atherosclerosis",
              "log_pvalue": 5.444,
              "beta": -0.00025,
              "ci_start": -0.02,
              "ci_end": 0.013
            },
            {
              "phenotype": "Endocarditis",
              "log_pvalue": 2.9893,
              "beta": -0.03475,
              "ci_start": -0.076,
              "ci_end": 0.007
            },
            {
              "phenotype": "Cardiomyopathy",
              "log_pvalue": 1.4141,
              "beta": 0.01425,
              "ci_start": -0.008,
              "ci_end": 0.037
            },
            {
              "phenotype": "Atrial flutter",
              "log_pvalue": 0.884,
              "beta": -0.02725,
              "ci_start": -0.057,
              "ci_end": 0.003
            }
          ]
        };

        /* Utility Functions â€“ basic combinators that reduce LocusZoom state against a type of layer data (including all layer data) */
        // not quite the same as defining SKI-combinators that are domain-specific but in the long run that's the idea
        // What makes them domain specific is that they include all of the LZ state options in their args
        var lzDataIdentity = sourceState => lzState => {
          console.log("identity", lzState);
          return sourceState;
        };
        var lzDataTerminateArray = sourceState => lzState => {
          console.log("terminate", lzState);
          return [];
        };
        var lzDataSetter = () => newSourceState => {
          console.log("settable");
          return newSourceState;
        }
        var lzPhewasFilter = sourceState => lzState => {
          console.log("random", sourceState, lzState);
          return {
              ...sourceState,
              data: sourceState.data.filter(phewas_point => phewas_point["log_pvalue"] > Math.random() * 5)
            }
        }

        var HlzLazyPromise = promise => sourceState => lzState => {
            // we provide a promise on sourceState because after the initial data is used in this reducer,
            // all subsequent states are promised states (regardless of what the initial data was).

            // luckily by handling all of the reductions through this function, we'll still see the sequence of data we need
            // without having to introduce any async to any other class, or changing our approach to using our synchronous reducers.

            return Promise.resolve(sourceState).then(sourceState => promise(sourceState, lzState));  // note that we can always ignore the second arg in the promise if necessary
        };

        // a timeout promise with a randomized delay that changes each call
        // simulates e.g. varying network conditions, arbitrarily changeable context data
        var wait = ms => new Promise(resolve => setTimeout(resolve, ms));
        var fail = error => console.error(`Browser feature failed? God help you. You got this error: ${error}`);
        var lzTimeoutPromise = state =>
            wait(state.ctx*1000).then(() => {
                console.log(state);
                console.log(`${state.ctx} second delay`);
                return { ...state, ctx: Math.random() * 3 };
            }).catch(fail);

        var lzRandomTimeout = HlzLazyPromise(lzTimeoutPromise);

        // HOF/type wrapper
        LocusZoom.Data.TLazy = (reduceFunc) => (initState) => {
          var current_state = initState;

          var handle_state = (args) => {
            if (typeof args !== "undefined") {
              current_state = (reduceFunc(current_state)(args));
              return LocusZoom.Data.TLazy(reduceFunc)(current_state);
            } else {
              return current_state;
            }
          }; // only return on evaluation

          return handle_state;

        };

        // Simplest implementation: the identity selector returns all of the data regardless of state

        console.group("Initialize Lazy Constructions");

        console.group('Lazy Identity');

          ALazyIdentity = LocusZoom.Data.TLazy(lzDataIdentity);
          console.log("ALazyIdentity", ALazyIdentity);

          ILazyIdentityPhewas = ALazyIdentity(phewas_forest);  // take phewas data as already loaded
          console.log("Give an ALazyIdentity a Phewas: ILazyIdentityPhewas", ILazyIdentityPhewas);

          console.group("Test ILazyIdentityPhewas", ILazyIdentityPhewas);

          getPhewasFromLazy1 = ILazyIdentityPhewas();  // equal to init data
          console.log("result data", getPhewasFromLazy1);

          getPhewasFromLazy2 = ILazyIdentityPhewas({})();  // should still be the same as the call above, but we'll get it through the identity reducer's execution stack
          console.log("result data from reduction", getPhewasFromLazy2);

          console.groupEnd();

        console.groupEnd();

        console.group('Lazy Termination');

          ALazyTermination = LocusZoom.Data.TLazy(lzDataTerminateArray);
          console.log("ALazyTermination", ALazyTermination);

          ILazyTerminationPhewas = ALazyTermination(phewas_forest);
          console.log("Give an ALazyTermination a Phewas: ILazyTerminationPhewas", ILazyTerminationPhewas);

          console.group('Test ILazyTerminationPhewas');
          getPhewasFromLazyTerm1 = ILazyTerminationPhewas();  // equal to init data
          console.log("result data", getPhewasFromLazyTerm1);

          getPhewasFromLazyTerm2 = ILazyTerminationPhewas({})();  // should still be the same as the call above, but we'll get it through the identity reducer's execution stack
          console.log("result data from reduction", getPhewasFromLazyTerm2);  // should be empty

          reduceDataTwice = ILazyTerminationPhewas({})({});  // observations "collapse" the object, which means if we want to do consecutive observations we need to store the instance of the object before observation
          observeTwiceData = reduceDataTwice();
          console.log("result data from twice reduction", observeTwiceData);  // should be empty array

          reduceDataThrice = reduceDataTwice({});  // 'reduceDataTwice({})' writes out as 'ILazyTerminationPhewas({})({})({})'
          observeThriceReduced = reduceDataThrice();
          console.log("result data from twice reduction", observeThriceReduced);  // should be empty array
          console.groupEnd();

        console.groupEnd();

        console.group('Test ILazySettablePhewas');

        ALazySettable = LocusZoom.Data.TLazy(lzDataSetter);
        console.log("ALazySettable", ALazySettable);

        ILazySettablePhewas = ALazySettable(phewas_forest);
        console.log("Give an ALazyTermination a Phewas: ILazyTerminationPhewas", ILazySettablePhewas);

        console.group('Lazy Setting');
        getPhewasFromLazySettable1 = ILazySettablePhewas();  // equal to init data
        console.log("result data", getPhewasFromLazySettable1);

        getPhewasFromLazySettable1 = ILazySettablePhewas({})();  // should still be the same as the call above, but we'll get it through the identity reducer's execution stack
        console.log("result data from reduction", getPhewasFromLazySettable1);  // should be `{}`

        reduceDataTwice = ILazySettablePhewas(1)(2);  // observations "collapse" the object, which means if we want to do consecutive observations we need to store the instance of the object before observation
        observeTwiceData = reduceDataTwice();
        console.log("result data from twice reduction", observeTwiceData);  // should be `2`

        reduceDataThrice = reduceDataTwice(3);  // 'reduceDataTwice(3)' writes out as 'ILazyTerminationPhewas(1)(2)(3)'
        observeThriceReduced = reduceDataThrice();
        console.log("result data from twice reduction", observeThriceReduced);  // should be `3`
        console.groupEnd();

        console.groupEnd();

        console.group('Test LazyTimeout');
        console.info('This forms the basis for prototyping the injection of promises');

        ALazyTimeout = LocusZoom.Data.TLazy(lzRandomTimeout);
        ILazyTimeoutPhewas = ALazyTimeout({...phewas_forest, ctx: 1});
        console.log("first observation", ILazyTimeoutPhewas());
        console.log("first reduction", ILazyTimeoutPhewas({}));
        console.log("second observation", ILazyTimeoutPhewas());

        console.groupEnd();

        console.groupEnd();

        ALazyRandomFilterPhewas = LocusZoom.Data.TLazy(lzPhewasFilter);
        ILazyRandomFilterPhewas = ALazyRandomFilterPhewas(phewas_forest);

        LocusZoom.Data.LazySource = LocusZoom.Data.Source.extend(function(ILazy) {
          this._lazyData = ILazy;
        },'LazyJSON');
        LocusZoom.Data.LazySource.prototype.getRequest = function(state, chain, fields) {
            this._lazyData = this._lazyData({state, chain, fields})
            return Promise.resolve(this._lazyData());
        };
        LocusZoom.Data.LazySource.prototype.toJSON = function() {
          return [Object.getPrototypeOf(this).constructor.SOURCE_NAME, this._lazyData()];
        };
        var data_sources = new LocusZoom.DataSources()
          .add("phewas", ["LazyJSON", ILazyTimeoutPhewas]);

        // Define a reusable layout, and then retrieve it so that the namespaces get filled in
        LocusZoom.Layouts.add("plot", "phewas_forest", {
            width: 800,
            height: 800,
            responsive_resize: 'both',
            panels: [
                {
                    id: "phewasforest",
                    width: 800,
                    height: 800,
                    proportional_width: 1,
                    margin: { top: 35, right: 220, bottom: 50, left: 20 },
                    inner_border: "rgba(210, 210, 210, 0.85)",
                    dashboard: {
                        components: [{
                            type: "toggle_legend",
                            position: "left"
                        }]
                    },
                    axes: {
                        x: {
                            label: "Beta",
                            label_offset: 33
                        },
                        y2: {
                            ticks: {  // Dynamically generated ticks, but specify custom options/styles to be used in every tick
                                style: {
                                    "font-weight": "bold",
                                    "text-anchor": "start"
                                }
                            }
                        }
                    },
                    legend: {
                        origin: { x: 30, y: 45 },
                        orientation: "vertical"
                    },
                    data_layers: [
                        {
                            namespace: { "phewas": "phewas" },
                            id: "phewas_forest",
                            type: "category_forest",
                            z_index: 1,
                            point_shape: "square",
                            point_size: {
                                scale_function: "interpolate",
                                field: "{{namespace[phewas]}}log_pvalue",
                                parameters: {
                                    breaks: [0, 10],
                                    values: [60, 160],
                                    null_value: 50
                                }
                            },
                            color: {
                                scale_function: "interpolate",
                                field: "{{namespace[phewas]}}log_pvalue",
                                parameters: {
                                    breaks: [0, 10],
                                    values: ["#fee8c8","#b30000"],
                                    null_value: "#B8B8B8"
                                }
                            },
                            legend: [
                                { label: "-log10 p-value" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#fdd49e", size: 60, label: "< 2" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#fdbb84", size: 80, label: "2 - 4" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#fc8d59", size: 100, label: "4 - 6" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#ef6548", size: 120, label: "6 - 8" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#d7301f", size: 140, label: "8 - 10" },
                                { shape: "square", class: "lz-data_layer-forest", color: "#b30000", size: 160, label: "10+" }
                            ],
                            id_field: "{{namespace[phewas]}}phenotype",
                            fields: ["{{namespace[phewas]}}phenotype", "{{namespace[phewas]}}log_pvalue", "{{namespace[phewas]}}log_pvalue|logtoscinotation", "{{namespace[phewas]}}beta", "{{namespace[phewas]}}ci_start", "{{namespace[phewas]}}ci_end"],
                            x_axis: {
                                field: "{{namespace[phewas]}}beta",
                                lower_buffer: 0.1,
                                upper_buffer: 0.1
                            },
                            y_axis: {
                                axis: 2,
                                category_field: "{{namespace[phewas]}}phenotype",  // Labels
                                field: "{{namespace[phewas]}}y_offset",  // Positions (dynamically added)
                            },
                            confidence_intervals: {
                                start_field: "{{namespace[phewas]}}ci_start",
                                end_field: "{{namespace[phewas]}}ci_end"
                            },
                            behaviors: {
                                onmouseover: [
                                    { action: "set", status: "highlighted" }
                                ],
                                onmouseout: [
                                    { action: "unset", status: "highlighted" }
                                ],
                                onclick: [
                                    { action: "toggle", status: "selected", exclusive: true }
                                ],
                                onshiftclick: [
                                    { action: "toggle", status: "selected" }
                                ]
                            },
                            tooltip: {
                                namespace: { "phewas": "phewas" },
                                closable: true,
                                show: { or: ["highlighted", "selected"] },
                                hide: { and: ["unhighlighted", "unselected"] },
                                html: "<strong>{{{{namespace[phewas]}}phenotype|htmlescape}}</strong><br>"
                                    + "P Value: <strong>{{{{namespace[phewas]}}log_pvalue|logtoscinotation|htmlescape}}</strong><br>"
                                    + "Odds Ratio: <strong>{{{{namespace[phewas]}}beta|htmlescape}}</strong><br>"
                                    + "95% Conf. Interval: <strong>[ {{{{namespace[phewas]}}ci_start|htmlescape}} {{{{namespace[phewas]}}ci_end|htmlescape}} ]</strong>"
                            }
                        },
                        {
                            id: "zeroline",
                            type: "orthogonal_line",
                            z_index: 0,
                            orientation: "vertical",
                            offset: 0,
                            y_axis: {
                                axis: 2
                            }
                        }
                    ]
                }
            ]
        });
        var layout = LocusZoom.Layouts.get("plot", "phewas_forest");
        window.plot = LocusZoom.populate("#plot", data_sources, layout);



      </script>

    </div>

  </body>
</html>
